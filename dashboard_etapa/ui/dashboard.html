<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAmazing Control | Operaci√≥n Activa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ‚ö†Ô∏è Config File: Credenciales de Supabase (NO incluido en repo) -->
    <script src="./config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0c0e;
            color: #e2e8f0;
        }

        .glass {
            background: rgba(23, 23, 26, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-text {
            background: linear-gradient(135deg, #a78bfa 0%, #22d3ee 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card-hover:hover {
            border-color: rgba(167, 139, 250, 0.5);
            transform: translateY(-2px);
            transition: all 0.2s ease;
        }

        .kanban-column {
            min-height: 500px;
        }

        input,
        select,
        textarea {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #a78bfa !important;
            outline: none;
        }

        .priority-5 {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(167, 139, 250, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3) !important;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% {
                border-color: rgba(239, 68, 68, 0.3);
            }

            50% {
                border-color: rgba(239, 68, 68, 0.6);
            }

            100% {
                border-color: rgba(239, 68, 68, 0.3);
            }
        }

        .sortable-ghost {
            opacity: 0.4;
            background: rgba(167, 139, 250, 0.2) !important;
            border: 2px dashed #a78bfa !important;
        }

        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            animation: slideIn 0.3s ease forwards;
            backdrop-filter: blur(12px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: linear-gradient(135deg, #a78bfa 0%, #22d3ee 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
            cursor: pointer;
        }
    </style>
</head>

<body class="antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 glass border-r border-white/10 hidden md:flex flex-col">
            <div class="p-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 bg-gradient-to-br from-violet-500 to-cyan-500 rounded-lg flex items-center justify-center">
                        <i data-lucide="zap" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="text-xl font-bold tracking-tight text-white">IA<span
                            class="gradient-text">mazing</span></span>
                </div>
            </div>
            <nav class="flex-1 px-4 space-y-2 mt-4">
                <a href="#" onclick="showView('dashboard')" id="nav-dashboard"
                    class="flex items-center gap-3 px-4 py-3 bg-white/5 rounded-xl text-violet-400">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Panel Maestro</span>
                </a>
                <a href="#" onclick="showView('my-desk')" id="nav-my-desk"
                    class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="briefcase" class="w-5 h-5"></i>
                    <span class="font-medium">Mi Escritorio</span>
                </a>
                <a href="#" onclick="showView('payments')" id="nav-payments"
                    class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="wallet" class="w-5 h-5"></i>
                    <span class="font-medium">Pagos y Gastos</span>
                </a>
                <a href="#" onclick="showView('cortex')" id="nav-cortex"
                    class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="brain" class="w-5 h-5"></i>
                    <span class="font-medium">Cortex AI</span>
                </a>
                <a href="#" onclick="showView('analytics')" id="nav-analytics"
                    class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span class="font-medium">M√©tricas</span>
                </a>
                <a href="#" onclick="showView('team-mgmt')" id="nav-team-mgmt"
                    class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="users-2" class="w-5 h-5"></i>
                    <span class="font-medium">Equipo</span>
                </a>
                <div class="pt-4 border-t border-white/5 mt-4">
                    <a href="#" onclick="openSettings()"
                        class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-white/5 rounded-xl transition-colors">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <span class="font-medium text-sm">Configuraci√≥n</span>
                    </a>
                </div>
            </nav>
            <!-- User Profile -->
            <div class="p-4 border-t border-white/10" id="current-user-sidebar">
                <div class="flex items-center gap-3 px-2">
                    <div class="user-avatar" id="user-avatar-initials">?</div>
                    <div class="flex-1 overflow-hidden">
                        <p class="text-xs font-bold text-white truncate" id="user-display-name">Identificarse</p>
                        <p class="text-[10px] text-slate-500 uppercase truncate" id="user-display-role">Sin Sesi√≥n</p>
                    </div>
                    <button onclick="openLogin()" class="text-slate-500 hover:text-white">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <!-- View: Dashboard (Manager) -->
            <div id="view-dashboard">
                <header class="flex flex-col xl:flex-row xl:items-center justify-between gap-6 mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-1">Control de Operaciones üïπÔ∏è</h1>
                        <p class="text-slate-400">Gesti√≥n global de la agencia.</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center gap-2 bg-white/5 p-1 rounded-xl border border-white/10">
                            <input type="text" id="search-project" placeholder="Buscar..."
                                class="bg-transparent !border-none text-xs w-32 focus:ring-0" oninput="loadDashboard()">
                            <select id="filter-client" class="bg-transparent !border-none text-[10px] w-28 focus:ring-0"
                                onchange="loadDashboard()">
                                <option value="">Todos los Clientes</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="document.getElementById('client-modal').classList.remove('hidden')"
                                class="px-4 py-2 glass hover:bg-white/10 rounded-xl border border-white/10 text-slate-300 text-sm">+
                                Cliente</button>
                            <button onclick="document.getElementById('project-modal').classList.remove('hidden')"
                                class="px-6 py-2 bg-gradient-to-r from-violet-600 to-cyan-600 rounded-xl font-semibold text-white shadow-lg shadow-violet-500/20 text-sm">+
                                Proyecto</button>
                        </div>
                    </div>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-12">
                    <div>
                        <h3 class="font-bold text-xs text-blue-400 px-2 uppercase tracking-widest mb-4">Briefing</h3>
                        <div id="col-briefing" class="kanban-column flex flex-col gap-4"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-xs text-amber-400 px-2 uppercase tracking-widest mb-4">Edici√≥n</h3>
                        <div id="col-production" class="kanban-column flex flex-col gap-4"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-xs text-violet-400 px-2 uppercase tracking-widest mb-4">QC</h3>
                        <div id="col-qc" class="kanban-column flex flex-col gap-4"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-xs text-emerald-400 px-2 uppercase tracking-widest mb-4">Entrega</h3>
                        <div id="col-completed" class="kanban-column flex flex-col gap-4"></div>
                    </div>
                </div>
                <!-- Team Availability -->
                <section class="mb-8" id="section-team">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-white"><i data-lucide="users"
                            class="w-5 h-5 text-violet-400"></i> Disponibilidad</h2>
                    <div id="team-grid" class="flex flex-wrap gap-4"></div>
                </section>
            </div>

            <!-- View: My Desk (Operator) -->
            <div id="view-my-desk" class="hidden">
                <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-1">Mi Escritorio üíª</h1>
                        <p class="text-slate-400">Enfoque total en tus entregas.</p>
                    </div>
                    <div class="glass px-6 py-4 rounded-3xl border border-white/10 flex items-center gap-6">
                        <div class="text-center">
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Saldo</p>
                            <p class="text-2xl font-bold text-emerald-400" id="my-personal-balance">$0.00</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Tareas</p>
                            <p class="text-2xl font-bold text-violet-400" id="my-active-tasks">0</p>
                        </div>
                    </div>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Pull System Pool -->
                        <section id="task-pool-section" class="hidden">
                            <h3
                                class="font-bold text-xs text-amber-500 uppercase tracking-widest mb-4 px-2 flex items-center gap-2">
                                <i data-lucide="shopping-bag" class="w-4 h-4"></i> Bolsa de Tareas Disponibles
                            </h3>
                            <div id="unassigned-projects-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </section>
                        <section>
                            <h3 class="font-bold text-xs text-slate-500 uppercase tracking-widest mb-4 px-2">Mis Tareas
                            </h3>
                            <div id="my-projects-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </section>
                    </div>
                    <div class="space-y-6">
                        <div class="glass p-6 rounded-3xl border border-white/10">
                            <h3 class="font-bold text-sm text-white mb-4">Notas R√°pidas</h3>
                            <textarea id="personal-notes" placeholder="Escribe aqu√≠ tus recordatorios..."
                                class="w-full h-32 bg-black/20 border-white/10 rounded-xl p-3 text-xs text-slate-300 focus:border-violet-500 outline-none resize-none"
                                oninput="savePersonalNotes()"></textarea>
                        </div>
                        <div class="glass p-6 rounded-3xl border border-white/10">
                            <h3 class="font-bold text-sm text-white mb-4">SOPs / Ayuda</h3>
                            <div class="space-y-2">
                                <button
                                    class="w-full text-left p-2 rounded-lg hover:bg-white/5 text-[10px] text-slate-400 flex items-center gap-2"><i
                                        data-lucide="file-text" class="w-3 h-3"></i> Gu√≠a Premium</button>
                                <button
                                    class="w-full text-left p-2 rounded-lg hover:bg-white/5 text-[10px] text-slate-400 flex items-center gap-2"><i
                                        data-lucide="check-square" class="w-3 h-3"></i> Checklist QC</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Payments (Financial) -->
            <div id="view-payments" class="hidden">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-white mb-1">Pagos & Finanzas üí∏</h1>
                    <p class="text-slate-400">Transparencia financiera absoluta.</p>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-2 glass p-6 rounded-3xl border border-white/10">
                        <h3 class="text-lg font-bold mb-4 text-white">Historial</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="text-slate-500 border-b border-white/5">
                                    <tr>
                                        <th class="py-3 px-2">Fecha</th>
                                        <th class="py-3 px-2">Editor</th>
                                        <th class="py-3 px-2">Monto</th>
                                        <th class="py-3 px-2">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-history" class="text-slate-300"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="glass p-6 rounded-3xl border border-white/10">
                        <h3 class="text-lg font-bold mb-4 text-white">Balances Pendientes</h3>
                        <div id="balances-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- View: Cortex AI -->
            <div id="view-cortex" class="hidden h-full flex flex-col">
                <header class="mb-4">
                    <h1 class="text-3xl font-bold text-white mb-1">Cortex Brain üß†</h1>
                    <p class="text-slate-400">Inteligencia operativa.</p>
                </header>
                <div class="flex-1 glass rounded-3xl border border-white/10 flex flex-col overflow-hidden mb-8">
                    <div id="cortex-chat" class="flex-1 p-6 overflow-y-auto flex flex-col gap-4"></div>
                    <div class="p-4 bg-white/5 border-t border-white/10">
                        <div class="flex gap-3">
                            <input type="text" id="cortex-input" placeholder="Preg√∫ntame algo..."
                                class="flex-1 rounded-xl px-4 py-3 bg-black/20 border-white/10 text-white focus:border-violet-500 outline-none"
                                onkeypress="if(event.key === 'Enter') sendCortex()">
                            <button onclick="sendCortex()"
                                class="p-3 bg-violet-600 hover:bg-violet-500 rounded-xl transition-colors"><i
                                    data-lucide="send" class="w-5 h-5 text-white"></i></button>
                        </div>
                    </div>
                </div>
                <!-- View: Analytics (Metrics) -->
                <div id="view-analytics" class="hidden">
                    <header class="mb-8">
                        <h1 class="text-3xl font-bold text-white mb-1">Anal√≠tica de Rendimiento üìä</h1>
                        <p class="text-slate-400">Datos y m√©tricas de producci√≥n en tiempo real.</p>
                    </header>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                        <div class="glass p-6 rounded-3xl border border-white/10">
                            <h3 class="text-lg font-bold mb-6 text-white flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-5 h-5 text-emerald-400"></i> Revenue Acumulado
                            </h3>
                            <div class="h-64">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        <div class="glass p-6 rounded-3xl border border-white/10">
                            <h3 class="text-lg font-bold mb-6 text-white flex items-center gap-2">
                                <i data-lucide="clock" class="w-5 h-5 text-violet-400"></i> Tiempo de Entrega (D√≠as)
                            </h3>
                            <div class="h-64">
                                <canvas id="efficiencyChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div
                            class="glass p-6 rounded-3xl border border-white/10 flex flex-col items-center justify-center text-center">
                            <p class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-2">Lead Time
                                Promedio</p>
                            <p class="text-4xl font-bold text-white" id="stat-lead-time">--</p>
                            <p class="text-[10px] text-slate-400 mt-2">D√≠as desde inicio a entrega</p>
                        </div>
                        <div
                            class="glass p-6 rounded-3xl border border-white/10 flex flex-col items-center justify-center text-center">
                            <p class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-2">Tasa de
                                Aprobaci√≥n</p>
                            <p class="text-4xl font-bold text-emerald-400" id="stat-approval">--</p>
                            <p class="text-[10px] text-slate-400 mt-2">Sin correcciones en QC</p>
                        </div>
                        <div
                            class="glass p-6 rounded-3xl border border-white/10 flex flex-col items-center justify-center text-center">
                            <p class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-2">Revenue Total</p>
                            <p class="text-4xl font-bold text-cyan-400" id="stat-revenue">--</p>
                            <p class="text-[10px] text-slate-400 mt-2">Registrado en sistema</p>
                        </div>
                    </div>
                </div>
                <!-- View: Team Mgmt (Admin) -->
                <div id="view-team-mgmt" class="hidden">
                    <header class="mb-8">
                        <h1 class="text-3xl font-bold text-white mb-1">Gesti√≥n de Equipo üë•</h1>
                        <p class="text-slate-400">Control de accesos y perfiles.</p>
                    </header>
                    <div class="glass p-6 rounded-3xl border border-white/10">
                        <table class="w-full text-left text-sm">
                            <thead class="text-slate-500 border-b border-white/5">
                                <tr>
                                    <th class="py-3 px-2">Miembro</th>
                                    <th class="py-3 px-2">Rol</th>
                                    <th class="py-3 px-2">Contrase√±a</th>
                                    <th class="py-3 px-2">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="team-mgmt-body" class="text-slate-300"></tbody>
                        </table>
                    </div>
                </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="login-modal"
        class="fixed inset-0 bg-black/95 backdrop-blur-md hidden flex items-center justify-center z-[100] p-4">
        <div class="glass w-full max-w-md p-10 rounded-[40px] border border-white/10 text-center">
            <div id="login-step-1">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-violet-500 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="zap" class="w-8 h-8 text-white"></i>
                </div>
                <h2 class="text-3xl font-bold text-white mb-2">IAmazing <span class="gradient-text">Agency</span></h2>
                <p class="text-slate-400 text-sm mb-8">Selecciona tu perfil para continuar.</p>
                <div class="space-y-3 mb-8" id="login-user-list"></div>
            </div>
            <div id="login-step-2" class="hidden">
                <button onclick="showLoginStep(1)"
                    class="text-xs text-slate-500 hover:text-white mb-6 flex items-center gap-2 mx-auto">
                    <i data-lucide="arrow-left" class="w-3 h-3"></i> Volver a la lista
                </button>
                <div class="w-16 h-16 rounded-2xl bg-white/5 flex items-center justify-center font-bold text-2xl text-violet-400 mx-auto mb-4 border border-white/10"
                    id="login-selected-avatar">?</div>
                <h3 class="text-2xl font-bold text-white mb-1" id="login-selected-name">Usuario</h3>
                <p class="text-xs text-slate-500 uppercase tracking-widest mb-8" id="login-selected-role">Puesto</p>
                <div class="space-y-4">
                    <input type="password" id="login-password" placeholder="Contrase√±a"
                        class="w-full rounded-xl px-4 py-4 bg-black/20 border-white/10 text-center text-white outline-none focus:border-violet-500 text-lg tracking-widest"
                        onkeypress="if(event.key === 'Enter') attemptLogin()">
                    <button onclick="attemptLogin()"
                        class="w-full py-4 bg-gradient-to-r from-violet-600 to-cyan-600 rounded-2xl font-bold text-white shadow-lg shadow-violet-600/20 active:scale-95 transition-transform">
                        Entrar al Sistema
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="project-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass w-full max-w-md p-8 rounded-3xl border border-white/10">
            <h2 class="text-2xl font-bold mb-6 text-white">Nuevo Proyecto</h2>
            <form id="project-form" class="space-y-4">
                <select id="form-client" required class="w-full rounded-xl px-4 py-3"></select>
                <div class="grid grid-cols-2 gap-4">
                    <select id="form-service" class="w-full rounded-xl px-4 py-3">
                        <option value="reel">üì± Reel / Short</option>
                        <option value="video">üéûÔ∏è Video Largo</option>
                        <option value="thumbnail">üé® Miniatura</option>
                    </select>
                    <select id="form-priority" class="w-full rounded-xl px-4 py-3">
                        <option value="1">Baja</option>
                        <option value="3" selected>Media</option>
                        <option value="5">Urgente</option>
                    </select>
                </div>
                <button type="submit" class="w-full py-3 bg-violet-600 rounded-xl font-bold text-white">Crear
                    Proyecto</button>
            </form>
        </div>
    </div>

    <div id="edit-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass w-full max-w-md p-8 rounded-3xl border border-white/10 text-white">
            <h2 class="text-2xl font-bold mb-6">Actualizar Proyecto</h2>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <select id="edit-assign" class="w-full rounded-xl px-4 py-3"></select>
                <input type="url" id="edit-raw" class="w-full rounded-xl px-4 py-3"
                    placeholder="URL Brutos (Drive/Dropbox)">
                <input type="url" id="edit-url" class="w-full rounded-xl px-4 py-3" placeholder="URL Entrega (Editado)">
                <button type="submit" class="w-full py-3 bg-cyan-600 rounded-xl font-bold">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="payment-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass w-full max-w-md p-8 rounded-3xl border border-white/10 text-white">
            <h2 class="text-2xl font-bold mb-6">Registrar Pago</h2>
            <form id="payment-form" class="space-y-4">
                <input type="hidden" id="pay-project-id">
                <select id="pay-editor" required class="w-full rounded-xl px-4 py-3"></select>
                <input type="number" id="pay-amount" step="0.01" required placeholder="0.00 $"
                    class="w-full rounded-xl px-4 py-3">
                <button type="submit" class="w-full py-3 bg-emerald-600 rounded-xl font-bold">Pagar</button>
            </form>
        </div>
    </div>

    <div id="settings-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass w-full max-w-md p-8 rounded-3xl border border-white/10 text-white">
            <h2 class="text-2xl font-bold mb-6">Ajustes</h2>
            <form id="settings-form" class="space-y-4">
                <input type="url" id="setting-webhook" placeholder="WhatsApp Webhook URL"
                    class="w-full rounded-xl px-4 py-3">
                <button type="submit" class="w-full py-3 bg-violet-600 rounded-xl font-bold">Guardar</button>
            </form>
        </div>
    </div>

    <div id="client-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass w-full max-w-md p-8 rounded-3xl border border-white/10 text-white">
            <h2 class="text-2xl font-bold mb-6">Nuevo Cliente</h2>
            <form id="client-form" class="space-y-4">
                <input type="text" id="client-name" placeholder="Nombre de la Empresa / Marca" required
                    class="w-full rounded-xl px-4 py-3 bg-black/20 border-white/10 text-white">
                <input type="text" id="client-whatsapp" placeholder="WhatsApp (ej: 34600000000)"
                    class="w-full rounded-xl px-4 py-3 bg-black/20 border-white/10 text-white">
                <button type="submit" class="w-full py-3 bg-violet-600 rounded-xl font-bold">Registrar Cliente</button>
            </form>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è CONFIGURACI√ìN DIN√ÅMICA (Securizada para GitHub)
        // Las credenciales se cargan desde config.js (archivo NO incluido en el repo)
        let SUPABASE_URL, SUPABASE_KEY, sb;

        // Intentar cargar configuraci√≥n
        try {
            // Si config.js existe y se importa correctamente
            if (typeof SUPABASE_CONFIG !== 'undefined') {
                SUPABASE_URL = SUPABASE_CONFIG.URL;
                SUPABASE_KEY = SUPABASE_CONFIG.ANON_KEY;
            } else {
                // Fallback: Pedir al usuario que configure
                alert('‚ö†Ô∏è Configuraci√≥n no encontrada.\n\nPor favor:\n1. Copia config.example.js como config.js\n2. Edita config.js con tus credenciales de Supabase\n3. Recarga esta p√°gina');
                throw new Error('Configuraci√≥n de Supabase no encontrada');
            }
            sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (error) {
            console.error('Error al cargar configuraci√≥n:', error);
        }

        let WHATSAPP_WEBHOOK_URL = localStorage.getItem('iamazing_webhook_url') || "";

        let teamData = [];
        let clientsData = [];
        let currentUser = null;
        let chartInstances = {};

        async function init() {
            lucide.createIcons();
            await loadConstants();
            checkSession();
            await loadDashboard();
            sb.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, () => loadDashboard()).subscribe();
            initSortable();
            renderToast("IAmazing Ready", "success");
        }

        function initSortable() {
            const cols = ['col-briefing', 'col-production', 'col-qc', 'col-completed'];
            cols.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                new Sortable(el, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: async (evt) => {
                        const pid = evt.item.dataset.id;
                        const newStatus = evt.to.id.replace('col-', '');
                        if (newStatus !== evt.from.id.replace('col-', '')) {
                            const success = await updateStatus(pid, newStatus);
                            if (!success) loadDashboard(); // Revertir visualmente si falla
                        }
                    }
                });
            });
        }

        function checkSession() {
            const uid = localStorage.getItem('iamazing_user_id');
            if (uid && teamData.find(m => m.id === uid)) {
                currentUser = teamData.find(m => m.id === uid);
                updateUserUI();
            }
            if (!currentUser) openLogin(); else updateUserUI();
        }

        function showLoginStep(step) {
            document.getElementById('login-step-1').classList.toggle('hidden', step !== 1);
            document.getElementById('login-step-2').classList.toggle('hidden', step !== 2);
            if (step === 2 && selectedUserTemp) {
                document.getElementById('login-selected-name').textContent = selectedUserTemp.first_name;
                document.getElementById('login-selected-role').textContent = selectedUserTemp.role.replace('_', ' ');
                document.getElementById('login-selected-avatar').textContent = selectedUserTemp.first_name[0];
                document.getElementById('login-password').value = '';
                document.getElementById('login-password').focus();
            }
        }

        function openLogin() {
            const list = document.getElementById('login-user-list');
            list.innerHTML = teamData.map(m => `
                <button onclick="selectUserForLogin('${m.id}')" class="w-full flex items-center gap-3 p-3 bg-white/5 hover:bg-white/10 rounded-2xl border border-white/5 transition-all text-left">
                    <div class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center font-bold text-violet-400">${m.first_name[0]}</div>
                    <div><p class="text-sm font-bold text-white">${m.first_name}</p><p class="text-[10px] text-slate-500 uppercase">${m.role.replace('_', ' ')}</p></div>
                </button>
            `).join('');
            showLoginStep(1);
            document.getElementById('login-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        let selectedUserTemp = null;
        window.selectUserForLogin = (uid) => {
            selectedUserTemp = teamData.find(m => m.id === uid);
            showLoginStep(2);
        };

        window.attemptLogin = async () => {
            const pass = document.getElementById('login-password').value;
            if (pass === selectedUserTemp.password) {
                localStorage.setItem('iamazing_user_id', selectedUserTemp.id);
                currentUser = selectedUserTemp;
                document.getElementById('login-modal').classList.add('hidden');
                updateUserUI();
                renderToast(`Hola ${currentUser.first_name}`, "success");
                loadDashboard();
            } else {
                renderToast("Contrase√±a incorrecta", "error");
            }
        }

        function updateUserUI() {
            if (!currentUser) return;
            document.getElementById('user-avatar-initials').textContent = currentUser.first_name[0];
            document.getElementById('user-display-name').textContent = currentUser.first_name;
            document.getElementById('user-display-role').textContent = currentUser.role.replace('_', ' ');
            const isManager = ['pm', 'coord_prod', 'sales_head'].includes(currentUser.role);
            document.getElementById('nav-dashboard').style.display = isManager ? 'flex' : 'none';
            document.getElementById('nav-payments').style.display = isManager ? 'flex' : 'none';
            document.getElementById('nav-analytics').style.display = isManager ? 'flex' : 'none';
            document.getElementById('nav-team-mgmt').style.display = isManager ? 'flex' : 'none';
            if (!isManager && !document.getElementById('view-dashboard').classList.contains('hidden')) showView('my-desk');
            document.getElementById('personal-notes').value = localStorage.getItem(`notes_${currentUser.id}`) || "";
        }

        function savePersonalNotes() {
            if (currentUser) localStorage.setItem(`notes_${currentUser.id}`, document.getElementById('personal-notes').value);
        }

        async function loadConstants() {
            const { data: team } = await sb.from('team_members').select('*');
            const { data: clients } = await sb.from('clients').select('*');
            teamData = team || []; clientsData = clients || [];
            const populate = (id, options) => { if (document.getElementById(id)) document.getElementById(id).innerHTML = options; };
            const clientOpts = clientsData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            populate('form-client', clientOpts);
            populate('filter-client', '<option value="">Todos</option>' + clientOpts);
            const editorOpts = teamData.filter(m => m.role.includes('editor')).map(m => `<option value="${m.id}">${m.first_name}</option>`).join('');
            populate('edit-assign', '<option value="">Desasignar</option>' + editorOpts);
            populate('pay-editor', editorOpts);
        }

        async function loadDashboard() {
            if (!currentUser) return;
            const isManager = ['pm', 'coord_prod', 'sales_head'].includes(currentUser.role);
            const { data: projects } = await sb.from('projects').select('*, clients(name, whatsapp), team_members(first_name)');
            const { data: payments } = await sb.from('project_payments').select('*');

            if (isManager) renderTeamMgmt();

            // MEJORA 3: Auto-Prioridad
            const now = new Date();
            projects?.forEach(p => {
                if (p.deadline) {
                    const diff = (new Date(p.deadline) - now) / (1000 * 3600);
                    if (diff < 24 && diff > 0 && p.status !== 'completed') p.is_expiring = true;
                }
            });

            const searchTerm = document.getElementById('search-project').value.toLowerCase();
            const filterClient = document.getElementById('filter-client').value;

            // Render Kanban (Manager)
            const cols = { briefing: 'col-briefing', production: 'col-production', qc: 'col-qc', completed: 'col-completed' };
            Object.values(cols).forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = ''; });

            projects?.filter(p => (!filterClient || p.client_id === filterClient) && (p.clients.name.toLowerCase().includes(searchTerm) || p.service_type.toLowerCase().includes(searchTerm)))
                .sort((a, b) => (b.is_expiring ? 10 : b.priority) - (a.is_expiring ? 10 : a.priority))
                .forEach(p => { document.getElementById(cols[p.status])?.appendChild(createCard(p, false, isManager)); });

            // MEJORA 1: Pull System (Personal Desk)
            const myWork = projects?.filter(p => p.assigned_to === currentUser.id && p.status !== 'completed');
            const pool = projects?.filter(p => !p.assigned_to && p.status === 'briefing');

            const myGrid = document.getElementById('my-projects-grid');
            if (myGrid) {
                myGrid.innerHTML = '';
                myWork.forEach(p => myGrid.appendChild(createCard(p, false, isManager)));
                document.getElementById('my-active-tasks').textContent = myWork.length;
            }

            const poolSection = document.getElementById('task-pool-section');
            const poolGrid = document.getElementById('unassigned-projects-grid');
            if (pool?.length > 0) {
                poolSection.classList.remove('hidden');
                poolGrid.innerHTML = '';
                pool.forEach(p => poolGrid.appendChild(createCard(p, true, isManager)));
            } else poolSection.classList.add('hidden');

            const myBal = payments?.filter(p => p.editor_id === currentUser.id).reduce((acc, p) => acc + parseFloat(p.amount), 0) || 0;
            if (document.getElementById('my-personal-balance')) document.getElementById('my-personal-balance').textContent = `$${myBal.toFixed(2)}`;

            // Team Grid & Payments Info
            const teamGrid = document.getElementById('team-grid');
            if (teamGrid) {
                teamGrid.innerHTML = teamData.map(m => `<div class="glass px-4 py-3 rounded-2xl flex items-center gap-3 border border-white/5"><div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-[10px] font-bold border border-white/10">${m.first_name[0]}</div><div><p class="text-[11px] font-bold text-white">${m.first_name}</p><p class="text-[9px] text-slate-500 uppercase">${m.role.replace('_', ' ')}</p></div></div>`).join('');
            }
            await loadPaymentsDetails();
            lucide.createIcons();
        }

        async function loadPaymentsDetails() {
            const { data: pms } = await sb.from('project_payments').select('*, team_members(first_name)');
            const hist = document.getElementById('payments-history');
            if (hist) hist.innerHTML = pms?.map(p => `<tr class="border-b border-white/5"><td class="py-3 px-2 text-[11px]">${new Date(p.created_at).toLocaleDateString()}</td><td class="py-3 px-2 text-[11px] font-bold">${p.team_members?.first_name}</td><td class="py-3 px-2 text-[11px] text-emerald-400">$${p.amount}</td><td class="py-3 px-2 text-[9px] uppercase font-bold text-emerald-500">${p.status}</td></tr>`).join('') || '';

            const balList = document.getElementById('balances-list');
            if (balList) {
                const totals = {};
                teamData.filter(m => m.role.includes('editor')).forEach(m => totals[m.id] = { name: m.first_name, sum: 0 });
                pms?.forEach(p => { if (totals[p.editor_id]) totals[p.editor_id].sum += parseFloat(p.amount); });
                balList.innerHTML = Object.values(totals).map(b => `<div class="flex justify-between items-center p-3 bg-white/5 rounded-xl"><span class="text-sm font-medium">${b.name}</span><span class="text-sm font-bold text-emerald-400">$${b.sum.toFixed(2)}</span></div>`).join('');
            }
        }

        function createCard(p, isPool = false, isManager = false) {
            const div = document.createElement('div');
            const colors = ["bg-slate-500", "bg-emerald-500", "bg-sky-500", "bg-amber-500", "bg-rose-500", "priority-5"];
            const urgentClass = p.is_expiring ? 'border-2 border-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.3)]' : 'border-white/5';
            div.className = `glass p-4 rounded-3xl border ${urgentClass} flex flex-col gap-3 relative transition-all hover:scale-[1.01] ${p.priority === 5 ? 'priority-5' : ''}`;
            div.dataset.id = p.id;

            div.innerHTML = `
                ${p.is_expiring ? '<div class="absolute -top-2 -left-2 bg-rose-600 text-[8px] font-bold px-2 py-1 rounded-full animate-pulse z-10">DEADLINE</div>' : ''}
                <div class="flex justify-between items-start">
                    <div><p class="text-[9px] uppercase font-bold text-slate-500 mb-0.5">${p.clients?.name}</p><h4 class="text-xs font-bold text-white">${p.service_type}</h4></div>
                    <span class="px-2 py-0.5 rounded text-[9px] font-black italic text-white ${colors[p.priority] || 'bg-slate-500'}">P${p.priority}</span>
                </div>
                <!-- Checklist QC (MEJORA 2) -->
                ${p.status === 'qc' || (p.checklist && p.checklist.length > 0) ? `
                    <div class="mt-2 pt-2 border-t border-white/5">
                        <p class="text-[8px] font-bold text-slate-600 uppercase mb-1">Feedback / QC</p>
                        <div class="space-y-1">
                            ${(p.checklist || []).map((item, idx) => `
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleCheckItem('${p.id}', ${idx})" class="w-2.5 h-2.5 rounded bg-white/5 border-white/10 accent-violet-500">
                                    <span class="text-[9px] ${item.done ? 'line-through text-slate-600' : 'text-slate-400'}">${item.text}</span>
                                </div>
                            `).join('')}
                        </div>
                        ${p.status === 'qc' ? `
                            <div class="mt-2 flex gap-1"><input type="text" id="chk-add-${p.id}" placeholder="Nota..." class="flex-1 bg-black/20 border-white/10 rounded px-2 py-0.5 text-[9px]"><button onclick="addCheckItem('${p.id}')" class="p-1 glass rounded text-violet-400 text-[9px]">+</button></div>
                        ` : ''}
                    </div>
                ` : ''}
                <div class="flex items-center gap-2 mt-auto pt-2">
                    ${isPool ? `
                        <button onclick="claimProject('${p.id}')" class="w-full py-2 bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-400 rounded-xl text-[10px] font-bold border border-emerald-500/30 transition-all flex items-center justify-center gap-2"><i data-lucide="user-plus" class="w-3 h-3"></i> Tomar Proyecto</button>
                    ` : `
                        <button onclick="openEdit('${p.id}', '${p.assigned_to}', '${p.production_url || ''}', '${p.raw_assets_url || ''}')" class="flex-1 py-1.5 bg-white/5 rounded-xl text-[10px] font-medium border border-white/5">Detalles</button>
                        ${(isManager && p.status === 'completed') ? `<button onclick="openPayment('${p.id}', '${p.assigned_to}')" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-white shadow-lg shadow-emerald-600/20"><i data-lucide="dollar-sign" class="w-3.5 h-3.5"></i></button>` : ''}
                        ${p.status !== 'completed' ? `<button onclick="moveToNext('${p.id}', '${p.status}')" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 rounded-xl text-white shadow-lg shadow-violet-600/20"><i data-lucide="chevron-right" class="w-3.5 h-3.5"></i></button>` : ''}
                    `}
                </div>
            `;
            lucide.createIcons();
            return div;
        }

        async function toggleCheckItem(pid, idx) {
            const { data } = await sb.from('projects').select('checklist').eq('id', pid).single();
            const list = data.checklist || []; list[idx].done = !list[idx].done;
            await sb.from('projects').update({ checklist: list }).eq('id', pid);
            renderToast("Feedback actualizado"); loadDashboard();
        }

        async function addCheckItem(pid) {
            const inp = document.getElementById(`chk-add-${pid}`); const text = inp.value.trim(); if (!text) return;
            const { data } = await sb.from('projects').select('checklist').eq('id', pid).single();
            const list = data.checklist || []; list.push({ text, done: false });
            await sb.from('projects').update({ checklist: list }).eq('id', pid);
            inp.value = ''; renderToast("Nota de QC a√±adida"); loadDashboard();
        }

        async function claimProject(pid) {
            await sb.from('projects').update({ assigned_to: currentUser.id, status: 'production' }).eq('id', pid);
            renderToast("Proyecto asignado exitosamente"); loadDashboard();
        }

        async function moveToNext(pid, current) {
            const next = { briefing: 'production', production: 'qc', qc: 'completed' }[current];
            if (next) await updateStatus(pid, next);
        }

        window.updateStatus = async (id, status, silent = false) => {
            // MEJORA 4: Bloqueador de Estado
            if (status === 'completed') {
                const { data: p } = await sb.from('projects').select('production_url').eq('id', id).single();
                if (!p.production_url) { renderToast("‚ö†Ô∏è Falta el link de entrega.", "error"); return false; }
            }
            const { data: proj } = await sb.from('projects').select('*, clients(*)').eq('id', id).single();
            const updates = { status };
            if (status === 'completed') updates.delivered_at = new Date();
            await sb.from('projects').update(updates).eq('id', id);
            if (!silent) renderToast(`Estado: ${status}`, "success");
            if (WHATSAPP_WEBHOOK_URL && (status === 'qc' || status === 'completed')) {
                fetch(WHATSAPP_WEBHOOK_URL, { method: 'POST', body: JSON.stringify({ project: proj.id, status, client: proj.clients.name }), headers: { 'Content-Type': 'application/json' } }).catch(() => { });
            }
            return true;
        };

        window.openEdit = (id, assign, url, raw) => {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-assign').value = assign || "";
            document.getElementById('edit-url').value = url;
            document.getElementById('edit-raw').value = raw || "";
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.openPayment = (pid, eid) => {
            document.getElementById('pay-project-id').value = pid;
            document.getElementById('pay-editor').value = eid || "";
            document.getElementById('payment-modal').classList.remove('hidden');
        };

        window.showView = (v) => {
            document.querySelectorAll('[id^="view-"]').forEach(x => x.classList.add('hidden'));
            document.getElementById(`view-${v}`).classList.remove('hidden');
            document.querySelectorAll('nav a').forEach(a => { a.classList.remove('text-violet-400', 'bg-white/5'); a.classList.add('text-slate-400'); });
            document.getElementById(`nav-${v}`)?.classList.add('text-violet-400', 'bg-white/5');
            if (v === 'analytics') renderAnalytics();
        };

        window.openSettings = () => {
            document.getElementById('setting-webhook').value = WHATSAPP_WEBHOOK_URL;
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        window.sendCortex = async () => {
            const input = document.getElementById('cortex-input'); const chat = document.getElementById('cortex-chat');
            const query = input.value.trim(); if (!query) return;
            const userBox = document.createElement('div'); userBox.className = "self-end bg-violet-600/20 p-3 rounded-2xl text-white text-xs border border-white/5"; userBox.textContent = query;
            chat.appendChild(userBox); input.value = ''; chat.scrollTop = chat.scrollHeight;

            const botBox = document.createElement('div'); botBox.className = "self-start bg-white/5 p-3 rounded-2xl text-slate-300 text-xs border border-white/5"; botBox.textContent = "... Cortex analizando ...";
            chat.appendChild(botBox);

            setTimeout(async () => {
                let resp = `Hola ${currentUser.first_name}. ¬øEn qu√© te ayudo?`;
                const q = query.toLowerCase();
                const { data: allProjects } = await sb.from('projects').select('*, clients(name)');

                if (q.includes('tarea') || q.includes('pendiente') || q.includes('feedback')) {
                    const myTasks = allProjects.filter(p => p.assigned_to === currentUser.id && p.status !== 'completed');
                    const withFeedback = myTasks.filter(p => p.checklist && p.checklist.some(i => !i.done));

                    if (q.includes('feedback') || q.includes('correcci√≥n')) {
                        if (withFeedback.length > 0) {
                            resp = `Tienes ${withFeedback.length} proyectos con feedback pendiente: ${withFeedback.map(p => p.clients.name + ' (' + p.service_type + ')').join(', ')}. Revisa tus tarjetas.`;
                        } else {
                            resp = "¬°Felicidades! No tienes feedback pendiente por ahora.";
                        }
                    } else {
                        resp = `Tienes ${myTasks.length} tareas activas. ${withFeedback.length > 0 ? 'Ojo: ' + withFeedback.length + ' tienen correcciones marcadas.' : ''}`;
                    }
                } else if (q.includes('pago') || q.includes('ganado') || q.includes('balance')) {
                    const { data } = await sb.from('project_payments').select('amount').eq('editor_id', currentUser.id);
                    const total = data?.reduce((acc, p) => acc + parseFloat(p.amount), 0) || 0;
                    resp = `Tu balance acumulado es de $${total.toFixed(2)}. Sigue as√≠.`;
                } else if (q.includes('disponibilidad') || q.includes('libre') || q.includes('equipo')) {
                    const counts = {};
                    teamData.filter(m => m.role.includes('editor')).forEach(m => {
                        counts[m.first_name] = allProjects.filter(p => p.assigned_to === m.id && p.status !== 'completed').length;
                    });
                    const ranking = Object.entries(counts).sort((a, b) => a[1] - b[1]);
                    resp = `El equipo est√° as√≠: ${ranking.map(([name, count]) => name + ' (' + count + ' tareas)').join(', ')}. ${ranking[0][0]} es quien tiene m√°s disponibilidad ahora.`;
                } else if (q.includes('vence') || q.includes('deadline') || q.includes('urgente')) {
                    const urgents = allProjects.filter(p => {
                        if (!p.deadline || p.status === 'completed') return false;
                        const diff = (new Date(p.deadline) - new Date()) / (1000 * 3600);
                        return diff < 48;
                    });
                    if (urgents.length > 0) {
                        resp = `Atenci√≥n: Hay ${urgents.length} proyectos que vencen pronto: ${urgents.map(p => p.clients.name).join(', ')}.`;
                    } else {
                        resp = "Estamos al d√≠a, no hay deadlines cr√≠ticos en las pr√≥ximas 48h.";
                    }
                }

                botBox.textContent = `CORTEX: ${resp}`;
                chat.scrollTop = chat.scrollHeight;
            }, 600);
        }

        async function renderAnalytics() {
            const { data: projects } = await sb.from('projects').select('*, clients(name)');
            const { data: payments } = await sb.from('project_payments').select('*');

            // 1. Stat Cards
            const completed = projects.filter(p => p.status === 'completed');
            const totalRevenue = payments.reduce((acc, p) => acc + parseFloat(p.amount), 0);
            document.getElementById('stat-revenue').textContent = `$${totalRevenue.toLocaleString()}`;

            const leadTimes = completed.filter(p => p.delivered_at).map(p => {
                const start = new Date(p.created_at);
                const end = new Date(p.delivered_at);
                return Math.max(0.1, (end - start) / (1000 * 3600 * 24));
            });
            const avgLead = leadTimes.length > 0 ? (leadTimes.reduce((a, b) => a + b) / leadTimes.length).toFixed(1) : "0";
            document.getElementById('stat-lead-time').textContent = avgLead;

            const approvalRate = completed.length > 0 ?
                ((completed.filter(p => !p.checklist || p.checklist.length === 0).length / completed.length) * 100).toFixed(0) + "%" : "--";
            document.getElementById('stat-approval').textContent = approvalRate;

            // 2. Revenue Chart (By Month)
            const revData = {};
            payments.forEach(p => {
                const m = new Date(p.created_at).toLocaleString('default', { month: 'short' });
                revData[m] = (revData[m] || 0) + parseFloat(p.amount);
            });

            renderChart('revenueChart', 'line', {
                labels: Object.keys(revData),
                datasets: [{
                    label: 'Revenue ($)',
                    data: Object.values(revData),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            });

            // 3. Projects per Client
            const clientVol = {};
            completed.forEach(p => {
                const name = p.clients?.name || 'Otro';
                clientVol[name] = (clientVol[name] || 0) + 1;
            });

            renderChart('efficiencyChart', 'bar', {
                labels: Object.keys(clientVol),
                datasets: [{
                    label: 'Videos Entregados',
                    data: Object.values(clientVol),
                    backgroundColor: '#8b5cf6',
                    borderRadius: 8
                }]
            });
            lucide.createIcons();
        }

        function renderTeamMgmt() {
            const body = document.getElementById('team-mgmt-body');
            if (!body) return;
            body.innerHTML = teamData.map(m => `
                <tr class="border-b border-white/5">
                    <td class="py-4 px-2 font-bold">${m.first_name}</td>
                    <td class="py-4 px-2 text-xs uppercase text-slate-500">${m.role.replace('_', ' ')}</td>
                    <td class="py-4 px-2"><input type="text" value="${m.password}" onchange="updatePassword('${m.id}', this.value)" class="bg-black/20 border border-white/10 rounded px-2 py-1 text-xs text-center w-24"></td>
                    <td class="py-4 px-2"><button class="p-2 text-slate-500 hover:text-white"><i data-lucide="shield-check" class="w-4 h-4"></i></button></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        window.updatePassword = async (uid, newPass) => {
            const { error } = await sb.from('team_members').update({ password: newPass }).eq('id', uid);
            if (!error) {
                renderToast("Contrase√±a actualizada", "success");
                await loadConstants();
            }
        }

        function renderChart(id, type, data) {
            if (chartInstances[id]) chartInstances[id].destroy();
            const canvas = document.getElementById(id);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            chartInstances[id] = new Chart(ctx, {
                type,
                data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#64748b', font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        document.getElementById('project-form').onsubmit = async (e) => {
            e.preventDefault();
            await sb.from('projects').insert([{ client_id: document.getElementById('form-client').value, service_type: document.getElementById('form-service').value, priority: parseInt(document.getElementById('form-priority').value), status: 'briefing' }]);
            closeAllModals(); reloadDashboard();
        }

        document.getElementById('edit-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            await sb.from('projects').update({ assigned_to: document.getElementById('edit-assign').value || null, production_url: document.getElementById('edit-url').value, raw_assets_url: document.getElementById('edit-raw').value }).eq('id', id);
            closeAllModals(); reloadDashboard();
        }

        document.getElementById('client-form').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('client-name').value;
            const whatsapp = document.getElementById('client-whatsapp').value;
            await sb.from('clients').insert([{ name, whatsapp }]);
            closeAllModals(); await loadConstants(); await loadDashboard();
            renderToast("Cliente registrado", "success");
        }

        document.getElementById('payment-form').onsubmit = async (e) => {
            e.preventDefault();
            const project_id = document.getElementById('pay-project-id').value;
            const editor_id = document.getElementById('pay-editor').value;
            const amount = document.getElementById('pay-amount').value;
            await sb.from('project_payments').insert([{ project_id, editor_id, amount, status: 'paid', paid_at: new Date() }]);
            closeAllModals(); reloadDashboard();
            renderToast("Pago registrado exitosamente", "success");
        }

        window.renderToast = (msg, type = "info") => {
            const cont = document.getElementById('toast-container') || (() => { const d = document.createElement('div'); d.id = 'toast-container'; d.className = 'toast-container'; document.body.appendChild(d); return d; })();
            const t = document.createElement('div'); t.className = `toast glass p-4 rounded-2xl border ${type === 'error' ? 'border-red-500/50 text-red-400' : 'border-violet-500/50 text-violet-400'} text-xs font-bold`;
            t.textContent = msg; cont.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        window.closeAllModals = () => document.querySelectorAll('.fixed').forEach(m => m.classList.add('hidden'));
        window.onload = init;
    </script>
</body>

</html>