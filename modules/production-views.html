<!-- ========================================
     MDULO: PRODUCCIN - Vistas
     ======================================== -->

<!-- Vista: Mi Escritorio (Producci贸n) -->
<div id="view-production-desk" class="hidden">
    <header class="flex flex-col xl:flex-row xl:items-center justify-between gap-6 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white mb-1">Mi Escritorio </h1>
            <p class="text-slate-400">Proyectos asignados a ti</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="glass px-5 py-3 rounded-xl border border-emerald-500/30">
                <span class="text-xs text-slate-500">Mi Balance:</span>
                <span class="text-lg font-bold text-emerald-400 ml-2" id="production-balance">$0.00</span>
            </div>
            <div class="glass px-5 py-3 rounded-xl">
                <span class="text-xs text-slate-500">Tareas Activas:</span>
                <span class="text-lg font-bold text-white ml-2" id="production-active-count">0</span>
            </div>
        </div>
    </header>

    <!-- Proyectos Activos -->
    <div class="space-y-4" id="production-my-projects">
        <!-- Cards generadas din谩micamente -->
    </div>

    <!-- Empty State -->
    <div id="production-empty-state" class="hidden empty-state">
        <i data-lucide="inbox" class="w-16 h-16 text-slate-600"></i>
        <p class="text-sm font-bold text-slate-500">No tienes proyectos asignados</p>
        <p class="subtitle">Revisa el pool de tareas disponibles</p>
        <button onclick="showModuleView('view-production-pool')"
            class="mt-4 px-6 py-3 bg-violet-600 hover:bg-violet-700 rounded-xl text-white font-bold">
            Ver Tareas Disponibles
        </button>
    </div>
</div>

<!-- Vista: Pool de Tareas (Producci贸n) -->
<div id="view-production-pool" class="hidden">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-1">Tareas Disponibles </h1>
        <p class="text-slate-400">Toma un proyecto cuando est茅s listo</p>
    </header>

    <!-- Filtros -->
    <div class="flex gap-3 mb-6">
        <select id="filter-pool-service" class="glass px-4 py-2 rounded-xl text-sm" onchange="loadProductionPool()">
            <option value="">Todos los Servicios</option>
            <option value="video">Video</option>
            <option value="reel">Reel</option>
            <option value="thumbnail">Thumbnail</option>
            <option value="pack">Pack</option>
        </select>
        <select id="filter-pool-priority" class="glass px-4 py-2 rounded-xl text-sm" onchange="loadProductionPool()">
            <option value="">Todas las Prioridades</option>
            <option value="5">Urgente (P5)</option>
            <option value="3">Media (P3)</option>
            <option value="1">Baja (P1)</option>
        </select>
    </div>

    <!-- Grid de Tareas -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="production-pool-grid">
        <!-- Cards generadas din谩micamente -->
    </div>

    <!-- Empty State -->
    <div id="pool-empty-state" class="hidden empty-state">
        <i data-lucide="check-circle" class="w-16 h-16 text-emerald-600"></i>
        <p class="text-sm font-bold text-slate-500">No hay tareas disponibles</p>
        <p class="subtitle">Todos los proyectos est谩n asignados</p>
    </div>
</div>

<!-- Vista: Calendario (Producci贸n) -->
<div id="view-production-calendar" class="hidden">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-1">Calendario de Entregas </h1>
        <p class="text-slate-400">Deadlines y planificaci贸n</p>
    </header>

    <!-- Selector de Mes -->
    <div class="flex items-center justify-between mb-6">
        <button onclick="changeCalendarMonth(-1)" class="glass px-4 py-2 rounded-xl hover:bg-white/10">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>
        <h2 class="text-xl font-bold text-white" id="calendar-month-year">Febrero 2026</h2>
        <button onclick="changeCalendarMonth(1)" class="glass px-4 py-2 rounded-xl hover:bg-white/10">
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- Calendario Grid -->
    <div class="glass rounded-xl p-6">
        <div class="grid grid-cols-7 gap-2 mb-4">
            <div class="text-center text-xs font-bold text-slate-500 py-2">Dom</div>
            <div class="text-center text-xs font-bold text-slate-500 py-2">Lun</div>
            <div class="text-center text-xs font-bold text-slate-500 py-2">Mar</div>
            <div class="text-center text-xs font-bold text-slate-500 py-2">Mi茅</div>
            <div class="text-center text-xs font-bold text-slate-500 py-2">Jue</div>
            <div class="text-center text-xs font-bold text-slate-500 py-2">Vie</div>
            <div class="text-center text-xs font-bold text-slate-500 py-2">S谩b</div>
        </div>
        <div class="grid grid-cols-7 gap-2" id="calendar-grid">
            <!-- D铆as generados din谩micamente -->
        </div>
    </div>

    <!-- Pr贸ximos Deadlines -->
    <div class="mt-8">
        <h3 class="text-lg font-bold text-white mb-4">Pr贸ximos Deadlines</h3>
        <div class="space-y-3" id="upcoming-deadlines">
            <!-- Lista generada din谩micamente -->
        </div>
    </div>
</div>

<!-- Vista: Mi Balance (Producci贸n) -->
<div id="view-production-balance" class="hidden">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-1">Mi Balance </h1>
        <p class="text-slate-400">Pagos y finanzas personales</p>
    </header>

    <!-- Resumen de Balance -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div
            class="glass p-6 rounded-xl border-2 border-emerald-500/30 bg-gradient-to-br from-emerald-900/20 to-transparent">
            <p class="text-xs uppercase text-emerald-400 font-bold mb-2">Balance Total</p>
            <h2 class="text-4xl font-bold text-white" id="balance-total">$0.00</h2>
            <p class="text-xs text-slate-500 mt-2">Desde el inicio</p>
        </div>
        <div class="glass p-6 rounded-xl">
            <p class="text-xs uppercase text-slate-500 font-bold mb-2">Este Mes</p>
            <h2 class="text-3xl font-bold text-white" id="balance-month">$0.00</h2>
        </div>
        <div class="glass p-6 rounded-xl">
            <p class="text-xs uppercase text-slate-500 font-bold mb-2">Pendiente</p>
            <h2 class="text-3xl font-bold text-amber-400" id="balance-pending">$0.00</h2>
        </div>
    </div>

    <!-- Historial de Pagos -->
    <div class="glass rounded-xl overflow-hidden">
        <div class="p-4 border-b border-white/10 flex justify-between items-center">
            <h3 class="font-bold text-white">Historial de Pagos</h3>
            <button class="px-3 py-2 glass rounded-lg text-xs hover:bg-white/10">
                <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                Exportar
            </button>
        </div>
        <table class="w-full">
            <thead>
                <tr class="border-b border-white/10">
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Fecha</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Proyecto</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Monto</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Status</th>
                </tr>
            </thead>
            <tbody id="balance-payments-table">
                <!-- Generado din谩micamente -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // === LGICA DEL MDULO DE PRODUCCIN ===

    async function loadProductionDesk() {
        if (!canAccessModule('projects', 'read')) {
            renderToast('No tienes permiso para ver proyectos', 'error');
            return;
        }

        try {
            // Cargar proyectos asignados al usuario actual
            const { data: projects, error } = await sb
                .from('deliveries')
                .select('*, clients(name)')
                .eq('assigned_to', currentUser.id)
                .neq('status', 'completed')
                .order('priority', { ascending: false });

            if (error) throw error;

            const container = document.getElementById('production-my-projects');
            const emptyState = document.getElementById('production-empty-state');
            const countEl = document.getElementById('production-active-count');

            if (!projects || projects.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                countEl.textContent = '0';
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            container.innerHTML = '';
            countEl.textContent = projects.length;

            projects.forEach(project => {
                const card = createProductionCard(project);
                container.appendChild(card);
            });

            // Cargar balance
            await loadProductionBalance();

        } catch (e) {
            console.error('Error loading production desk:', e);
            renderToast('Error al cargar escritorio', 'error');
        }
    }

    function createProductionCard(project) {
        const div = document.createElement('div');
        div.className = 'glass p-6 rounded-xl card-hover';

        const priorityColors = {
            1: 'slate',
            3: 'cyan',
            5: 'rose'
        };
        const color = priorityColors[project.priority] || 'slate';

        div.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div>
                <p class="text-xs uppercase font-bold text-slate-500 mb-1">${project.clients?.name || 'Cliente'}</p>
                <h3 class="text-lg font-bold text-white">${project.service_type}</h3>
            </div>
            <span class="px-3 py-1 rounded-lg text-xs font-bold border bg-${color}-500/20 text-${color}-400 border-${color}-500/30">
                P${project.priority}
            </span>
        </div>

        ${project.deadline ? `
            <div class="flex items-center gap-2 text-xs text-slate-400 mb-4">
                <i data-lucide="calendar" class="w-4 h-4"></i>
                Deadline: ${new Date(project.deadline).toLocaleDateString()}
            </div>
        ` : ''}

        <div class="flex gap-2">
            <button onclick="openEdit('${project.id}', '${project.assigned_to}', '${project.production_url || ''}', '${project.raw_assets_url || ''}')" 
                    class="flex-1 py-2 glass rounded-lg text-xs hover:bg-white/10">
                Ver Detalles
            </button>
            ${project.status !== 'completed' ? `
                <button onclick="moveToNext('${project.id}', '${project.status}')" 
                        class="px-4 py-2 bg-violet-600 hover:bg-violet-700 rounded-lg text-white">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            ` : ''}
        </div>
    `;

        lucide.createIcons();
        return div;
    }

    async function loadProductionPool() {
        try {
            const serviceFilter = document.getElementById('filter-pool-service')?.value;
            const priorityFilter = document.getElementById('filter-pool-priority')?.value;

            let query = sb
                .from('deliveries')
                .select('*, clients(name)')
                .is('assigned_to', null)
                .eq('status', 'briefing');

            if (serviceFilter) query = query.eq('service_type', serviceFilter);
            if (priorityFilter) query = query.eq('priority', parseInt(priorityFilter));

            const { data: projects, error } = await query.order('priority', { ascending: false });

            if (error) throw error;

            const grid = document.getElementById('production-pool-grid');
            const emptyState = document.getElementById('pool-empty-state');

            if (!projects || projects.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');
            grid.innerHTML = '';

            projects.forEach(project => {
                const card = createPoolCard(project);
                grid.appendChild(card);
            });

        } catch (e) {
            console.error('Error loading production pool:', e);
        }
    }

    function createPoolCard(project) {
        const div = document.createElement('div');
        div.className = 'glass p-5 rounded-xl card-hover';
        div.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <h4 class="font-bold text-white">${project.service_type}</h4>
            <span class="text-xs px-2 py-1 bg-violet-500/20 text-violet-400 rounded">P${project.priority}</span>
        </div>
        <p class="text-xs text-slate-400 mb-4">${project.clients?.name || 'Cliente'}</p>
        <button onclick="claimProject('${project.id}')" 
                class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold flex items-center justify-center gap-2">
            <i data-lucide="user-plus" class="w-4 h-4"></i>
            Tomar Proyecto
        </button>
    `;
        lucide.createIcons();
        return div;
    }

    async function loadProductionBalance() {
        try {
            const { data: payments } = await sb
                .from('project_payments')
                .select('*')
                .eq('editor_id', currentUser.id);

            const total = payments?.reduce((sum, p) => sum + parseFloat(p.amount), 0) || 0;
            document.getElementById('production-balance').textContent = `$${total.toFixed(2)}`;
            document.getElementById('balance-total').textContent = `$${total.toFixed(2)}`;

            // Calcular mes actual
            const now = new Date();
            const monthPayments = payments?.filter(p => {
                const date = new Date(p.created_at);
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }) || [];

            const monthTotal = monthPayments.reduce((sum, p) => sum + parseFloat(p.amount), 0);
            document.getElementById('balance-month').textContent = `$${monthTotal.toFixed(2)}`;

            // Renderizar tabla
            const table = document.getElementById('balance-payments-table');
            if (table) {
                table.innerHTML = payments?.map(p => `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-4 text-sm">${new Date(p.created_at).toLocaleDateString()}</td>
                    <td class="p-4 text-sm">Proyecto #${p.project_id.substring(0, 8)}</td>
                    <td class="p-4 text-sm font-bold text-emerald-400">$${parseFloat(p.amount).toFixed(2)}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${p.status === 'paid' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}">
                            ${p.status}
                        </span>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="p-8 text-center text-slate-500">No hay pagos registrados</td></tr>';
            }

        } catch (e) {
            console.error('Error loading balance:', e);
        }
    }

    window.loadProductionDesk = loadProductionDesk;
    window.loadProductionPool = loadProductionPool;
    window.loadProductionBalance = loadProductionBalance;
</script>