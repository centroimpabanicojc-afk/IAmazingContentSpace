<!-- ========================================
     MÃ“DULO: VENTAS - Pipeline de Leads
     ======================================== -->

<!-- Vista: Pipeline de Ventas -->
<div id="view-sales-pipeline" class="hidden">
    <header class="flex flex-col xl:flex-row xl:items-center justify-between gap-6 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white mb-1">Pipeline de Ventas ðŸ“ˆ</h1>
            <p class="text-slate-400">Gestiona tus leads y conversiones</p>
        </div>
        <button onclick="openNewLeadModal()"
            class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 rounded-xl text-white font-bold flex items-center gap-2 shadow-lg shadow-emerald-600/20">
            <i data-lucide="plus" class="w-5 h-5"></i>
            Nuevo Lead
        </button>
    </header>

    <!-- MÃ©tricas Personales -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="glass p-5 rounded-xl border border-emerald-500/30">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs uppercase font-bold text-emerald-400">ConversiÃ³n</p>
                <i data-lucide="trending-up" class="w-4 h-4 text-emerald-400"></i>
            </div>
            <h3 class="text-3xl font-bold text-white" id="sales-conversion-rate">0%</h3>
            <p class="text-xs text-slate-500 mt-1">Este mes</p>
        </div>
        <div class="glass p-5 rounded-xl border border-violet-500/30">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs uppercase font-bold text-violet-400">Comisiones</p>
                <i data-lucide="dollar-sign" class="w-4 h-4 text-violet-400"></i>
            </div>
            <h3 class="text-3xl font-bold text-white" id="sales-commissions">$0</h3>
            <p class="text-xs text-slate-500 mt-1">Ganadas</p>
        </div>
        <div class="glass p-5 rounded-xl border border-cyan-500/30">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs uppercase font-bold text-cyan-400">Clientes</p>
                <i data-lucide="users" class="w-4 h-4 text-cyan-400"></i>
            </div>
            <h3 class="text-3xl font-bold text-white" id="sales-active-clients">0</h3>
            <p class="text-xs text-slate-500 mt-1">Activos</p>
        </div>
        <div class="glass p-5 rounded-xl border border-amber-500/30">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs uppercase font-bold text-amber-400">En Pipeline</p>
                <i data-lucide="inbox" class="w-4 h-4 text-amber-400"></i>
            </div>
            <h3 class="text-3xl font-bold text-white" id="sales-leads-count">0</h3>
            <p class="text-xs text-slate-500 mt-1">Leads activos</p>
        </div>
    </div>

    <!-- Kanban de Leads -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Columna: Nuevos -->
        <div class="glass p-4 rounded-xl min-h-[400px]">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-slate-300 flex items-center gap-2">
                    <span class="w-2 h-2 bg-slate-500 rounded-full"></span>
                    NUEVOS
                </h3>
                <span class="text-xs bg-white/10 px-2 py-1 rounded-full" id="count-leads-new">0</span>
            </div>
            <div class="space-y-3" id="leads-new"></div>
        </div>

        <!-- Columna: Contactados -->
        <div class="glass p-4 rounded-xl min-h-[400px]">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-cyan-400 flex items-center gap-2">
                    <span class="w-2 h-2 bg-cyan-500 rounded-full"></span>
                    CONTACTADOS
                </h3>
                <span class="text-xs bg-cyan-500/20 px-2 py-1 rounded-full text-cyan-300"
                    id="count-leads-contacted">0</span>
            </div>
            <div class="space-y-3" id="leads-contacted"></div>
        </div>

        <!-- Columna: Propuesta -->
        <div class="glass p-4 rounded-xl min-h-[400px]">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-amber-400 flex items-center gap-2">
                    <span class="w-2 h-2 bg-amber-500 rounded-full"></span>
                    PROPUESTA
                </h3>
                <span class="text-xs bg-amber-500/20 px-2 py-1 rounded-full text-amber-300"
                    id="count-leads-proposal">0</span>
            </div>
            <div class="space-y-3" id="leads-proposal"></div>
        </div>

        <!-- Columna: Cerrados -->
        <div class="glass p-4 rounded-xl min-h-[400px]">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-emerald-400 flex items-center gap-2">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
                    CERRADOS
                </h3>
                <span class="text-xs bg-emerald-500/20 px-2 py-1 rounded-full text-emerald-300"
                    id="count-leads-closed">0</span>
            </div>
            <div class="space-y-3" id="leads-closed"></div>
        </div>
    </div>
</div>

<!-- Vista: Clientes (Ventas) -->
<div id="view-sales-clients" class="hidden">
    <header class="flex flex-col xl:flex-row xl:items-center justify-between gap-6 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white mb-1">Mis Clientes ðŸ‘¥</h1>
            <p class="text-slate-400">Clientes activos y prospectos</p>
        </div>
        <button onclick="document.getElementById('client-modal').classList.remove('hidden')"
            class="px-6 py-3 bg-cyan-600 hover:bg-cyan-700 rounded-xl text-white font-bold flex items-center gap-2">
            <i data-lucide="user-plus" class="w-5 h-5"></i>
            Nuevo Cliente
        </button>
    </header>

    <!-- Filtros -->
    <div class="flex gap-3 mb-6">
        <select id="filter-client-status" class="glass px-4 py-2 rounded-xl text-sm" onchange="loadSalesClients()">
            <option value="">Todos los Status</option>
            <option value="active">Activos</option>
            <option value="inactive">Inactivos</option>
            <option value="lead">Leads</option>
        </select>
        <input type="text" id="search-sales-clients" placeholder="Buscar cliente..."
            class="glass px-4 py-2 rounded-xl text-sm flex-1" oninput="loadSalesClients()">
    </div>

    <!-- Tabla de Clientes -->
    <div class="glass rounded-xl overflow-hidden">
        <table class="w-full">
            <thead>
                <tr class="border-b border-white/10">
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Cliente</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Tipo</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Status</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Proyectos</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Contacto</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Acciones</th>
                </tr>
            </thead>
            <tbody id="sales-clients-table">
                <!-- Generado dinÃ¡micamente -->
            </tbody>
        </table>
    </div>
</div>

<!-- Vista: Comisiones (Ventas) -->
<div id="view-sales-commissions" class="hidden">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-1">Mis Comisiones ðŸ’°</h1>
        <p class="text-slate-400">Historial de comisiones ganadas</p>
    </header>

    <!-- Resumen -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div
            class="glass p-6 rounded-xl border-2 border-emerald-500/30 bg-gradient-to-br from-emerald-900/20 to-transparent">
            <p class="text-xs uppercase text-emerald-400 font-bold mb-2">Total Ganado</p>
            <h2 class="text-4xl font-bold text-white" id="total-commissions">$0.00</h2>
            <p class="text-xs text-slate-500 mt-2">Desde el inicio</p>
        </div>
        <div class="glass p-6 rounded-xl">
            <p class="text-xs uppercase text-slate-500 font-bold mb-2">Este Mes</p>
            <h2 class="text-3xl font-bold text-white" id="month-commissions">$0.00</h2>
        </div>
        <div class="glass p-6 rounded-xl">
            <p class="text-xs uppercase text-slate-500 font-bold mb-2">Promedio Mensual</p>
            <h2 class="text-3xl font-bold text-white" id="avg-commissions">$0.00</h2>
        </div>
    </div>

    <!-- Historial -->
    <div class="glass rounded-xl overflow-hidden">
        <div class="p-4 border-b border-white/10">
            <h3 class="font-bold text-white">Historial de Comisiones</h3>
        </div>
        <table class="w-full">
            <thead>
                <tr class="border-b border-white/10">
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Fecha</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Cliente</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Proyecto</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Monto</th>
                    <th class="text-left p-4 text-xs uppercase font-bold text-slate-500">Status</th>
                </tr>
            </thead>
            <tbody id="commissions-table">
                <!-- Generado dinÃ¡micamente -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal: Nuevo Lead -->
<div id="new-lead-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="glass max-w-md w-full rounded-2xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">Nuevo Lead</h2>
        <form id="new-lead-form" class="space-y-4">
            <div>
                <label class="text-xs font-bold text-slate-400 mb-2 block">Nombre</label>
                <input type="text" id="lead-name" required class="w-full px-4 py-3 glass rounded-xl">
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 mb-2 block">WhatsApp</label>
                <input type="tel" id="lead-whatsapp" required class="w-full px-4 py-3 glass rounded-xl">
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 mb-2 block">Email</label>
                <input type="email" id="lead-email" class="w-full px-4 py-3 glass rounded-xl">
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 mb-2 block">Tipo</label>
                <select id="lead-type" class="w-full px-4 py-3 glass rounded-xl">
                    <option value="creator">Creator</option>
                    <option value="pyme">PYME</option>
                    <option value="agency">Agencia</option>
                </select>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="document.getElementById('new-lead-modal').classList.add('hidden')"
                    class="flex-1 px-4 py-3 glass rounded-xl hover:bg-white/10">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-3 bg-emerald-600 hover:bg-emerald-700 rounded-xl text-white font-bold">
                    Crear Lead
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // === LÃ“GICA DEL MÃ“DULO DE VENTAS ===

    async function loadSalesPipeline() {
        if (!canAccessModule('clients', 'read')) {
            renderToast('No tienes permiso para ver el pipeline', 'error');
            return;
        }

        try {
            // Cargar clientes con status 'lead'
            const { data: leads, error } = await sb
                .from('clients')
                .select('*')
                .eq('status', 'lead')
                .order('created_at', { ascending: false });

            if (error) throw error;

            // Agrupar por etapa (usando metadata.stage)
            const stages = { new: [], contacted: [], proposal: [], closed: [] };
            leads.forEach(lead => {
                const stage = lead.metadata?.stage || 'new';
                if (stages[stage]) stages[stage].push(lead);
            });

            // Renderizar cada columna
            Object.keys(stages).forEach(stage => {
                const container = document.getElementById(`leads-${stage}`);
                const count = document.getElementById(`count-leads-${stage}`);
                if (!container) return;

                container.innerHTML = '';
                count.textContent = stages[stage].length;

                stages[stage].forEach(lead => {
                    const card = createLeadCard(lead);
                    container.appendChild(card);
                });
            });

            // Actualizar mÃ©tricas
            updateSalesMetrics(leads);

        } catch (e) {
            console.error('Error loading sales pipeline:', e);
            renderToast('Error al cargar pipeline', 'error');
        }
    }

    function createLeadCard(lead) {
        const div = document.createElement('div');
        div.className = 'glass p-4 rounded-xl hover:bg-white/5 cursor-pointer transition-all';
        div.innerHTML = `
        <h4 class="font-bold text-white text-sm mb-2">${lead.name}</h4>
        <p class="text-xs text-slate-400 mb-2">${lead.type}</p>
        <div class="flex items-center gap-2 text-xs text-slate-500">
            <i data-lucide="phone" class="w-3 h-3"></i>
            ${lead.whatsapp}
        </div>
    `;
        div.onclick = () => openLeadDetails(lead.id);
        return div;
    }

    async function updateSalesMetrics(leads) {
        // Calcular conversiÃ³n (leads cerrados / total)
        const closed = leads.filter(l => l.metadata?.stage === 'closed').length;
        const conversionRate = leads.length > 0 ? ((closed / leads.length) * 100).toFixed(0) : 0;
        document.getElementById('sales-conversion-rate').textContent = `${conversionRate}%`;

        // Cargar comisiones del usuario
        const { data: commissions } = await sb
            .from('deliveries')
            .select('sales_commission')
            .eq('sales_rep_id', currentUser.id);

        const totalCommissions = commissions?.reduce((sum, c) => sum + (c.sales_commission || 0), 0) || 0;
        document.getElementById('sales-commissions').textContent = `$${totalCommissions.toFixed(0)}`;

        // Clientes activos
        const { count } = await sb
            .from('clients')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'active');

        document.getElementById('sales-active-clients').textContent = count || 0;
        document.getElementById('sales-leads-count').textContent = leads.length;
    }

    window.openNewLeadModal = () => {
        document.getElementById('new-lead-modal').classList.remove('hidden');
    };

    window.loadSalesPipeline = loadSalesPipeline;
</script>